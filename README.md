# Сtrader Email Parser

Скрипт подключается к IMAP‑ящику, парсит HTML‑письма от cTrader и присылает алерты в Slack. Для каждого письма извлекаются
основные поля сделки, после чего объём рассчитывается по формуле из `symbols.csv`. Если значение превышает лимит, бот отправляет
уведомление и сохраняет UID письма, чтобы не обрабатывать его повторно. При изменении `symbols.csv` процесс автоматически
перезапускается и подхватывает новые параметры.

## Фильтрация сообщений перед отправкой в Slack

Скрипт фильтрует сообщения, поступающие на IMAP-аккаунт, перед отправкой уведомлений в Slack. Фильтрация осуществляется по нескольким ключевым параметрам письма: объему сделки, символу (инструменту), типу сделки и другим параметрам. Ниже приведены основные способы фильтрации:

### 1. Фильтрация по объему сделки
Фильтрация по объему сделки является одной из главных для отправки уведомлений. Объем вычисляется на основе данных из письма и соответствующих правил, указанных в файле `symbols.csv`. Если объем превышает установленный лимит для конкретного символа, сообщение будет отправлено в Slack.

- Извлекается объем сделки.
- Вычисляется объем по правилам из файла `symbols.csv` (в лотах или в деньгах).
- Если вычисленный объем превышает пороговое значение, установленное в `symbols.csv`, сообщение отправляется в Slack.

### 2. Фильтрация по символу (инструменту)
Каждое письмо связано с конкретным символом (например, `XAUUSD` или `XAGUSD`). Если символ из письма не указан в файле `symbols.csv`, используется резервный формат сообщения, который не включает расчет объема.

- Извлекается символ из письма.
- Если символ присутствует в `symbols.csv`, применяются правила для вычисления объема.
- Если символ отсутствует в таблице, используется дефолтный формат сообщения для Slack.

### 3. Фильтрация по типу сделки (Trade Side)
Фильтрация также может быть настроена по типу сделки (например, `BUY` или `SELL`). Это позволяет отправлять уведомления только для сделок определенного типа.

- Извлекается тип сделки из письма (параметр `Trade Side`).
- На основе значения этого параметра можно настроить фильтрацию сообщений, например, отправлять уведомления только для сделок типа `SELL` или только для сделок типа `BUY`.

### 4. Фильтрация по аккаунту
Вы можете настроить фильтрацию сообщений, исходя из аккаунта, указанных в письме. Это полезно для разделения уведомлений по различным аккаунтам.

- Извлекается аккаунт из письма (параметр `Account`).
- Можно настроить фильтрацию по конкретным аккаунтам, отправляя уведомления только для определенных аккаунтов.

### 5. Резервная фильтрация (если данные не найдены)
Если в письме отсутствуют необходимые данные (например, не удалось извлечь символ или объем), используется резервный формат для отправки уведомлений в Slack. В этом случае сообщение отправляется в стандартном виде, без расчетов объема.

- Если не удается извлечь символ или объем, используется дефолтный формат сообщения.
- В этом случае объем может быть отображен в исходной валюте (например, в `EUR/lot`), а не в расчетных единицах.

### 6. Логирование и отслеживание ошибок
При фильтрации сообщений также осуществляется логирование ошибок, чтобы в случае проблем с фильтрацией можно было легко определить, что пошло не так.

- В случае возникновения ошибок при фильтрации (например, неверный формат данных), они фиксируются в логах.
- Логи содержат информацию о причинах отказа в отправке уведомления (например, объем не превышает лимит или данные отсутствуют).

### 7. Как добавить свои правила фильтрации
Вы можете настроить дополнительные правила фильтрации, добавив их в код в соответствующих местах. Для этого потребуется:
- Изменить логику вычисления объема.
- Добавить дополнительные условия для фильтрации по типу сделки или аккаунту.
- Обновить файл `symbols.csv` с новыми параметрами символов и лимитов, если это необходимо.

Все изменения в файле `symbols.csv` автоматически отслеживаются, и скрипт перезапускается для применения новых правил.



## Требования
- Python 3.9+
- Доступ к IMAP‑почте, где приходят уведомления cTrader
- Установленные зависимости: `pip install -r requirements.txt`

## Настройка окружения
1. Клонируйте репозиторий, например `/home/user/ctrader_email_parser` или `C:\\ctrader_email_parser`.
2. Создайте `.env` в корне проекта. Минимальный набор переменных:
   ```
   IMAP_HOST=imap.example.com
   IMAP_USER=user@example.com
   IMAP_PASS=password123
   SLACK_URL=https://hooks.slack.com/services/XXX/YYY/ZZZ
   CHECK_SEC=10
   ```
   Добавьте `PYTHON=/usr/bin/python3.11`, если для `run.sh` нужен нестандартный интерпретатор.
3. Установите зависимости: `python -m pip install -r requirements.txt`.

## Таблица `symbols.csv`
CSV‑файл управляет тем, как считается объём для каждого инструмента:
```
symbol,formula,volume_limit,contract_size,type
XAUUSD,lots,40,100,forex
XAGUSD,money,20,100,forex
```
- `symbol` — название инструмента из письма (регистр не важен).
- `formula` — `lots` или `money`:
  - `lots`: объём = значение поля `Volume` / `contract_size`, округляется до сотых и выводится в лотах.
  - `money`: объём = `Volume in USD` / 1 000 000, итоговая единица — `m` (миллионы), например `1.16 m`.
- `volume_limit` — порог, с которым сравнивается рассчитанный объём.
- `contract_size` — нужен только для формулы `lots`.
- `type` — группировка символов.

Если файл изменить, `ctrader.py` заметит новое время модификации и перезапустится, поэтому правки применяются без ручной
остановки процесса.

## Формат Slack‑уведомлений
Когда символ найден в таблице и объём выше лимита, сообщение выглядит так:
```
:exclamation:`Large Volume Traded` *[USD]*: *CT-LIVE-123456<https://admin.litefinance.com/c-trader/view?server=90&login=123456|[web]>*  *SELL*  *10.00 lot*  *XAUUSD*
```
Для формулы `money` единица будет `m`, например `*1.16 m*`.
Если инструмент отсутствует в `symbols.csv`, применяется резервный формат из исходных полей письма.

## Запуск на Windows
1. Убедитесь, что Python установлен и доступен (или укажите полный путь в `run.bat`).
2. Отредактируйте `run.bat`, чтобы он переходил в папку проекта и подхватывал `.env`.
3. Запустите `run.bat` вручную или через Task Scheduler.

## Запуск на Linux
1. Сделайте `run.sh` исполняемым: `chmod +x run.sh`.
2. Убедитесь, что в `.env` задан путь `PYTHON`, если нужен кастомный интерпретатор.
3. Запустите `./run.sh`. Стандартный вывод/ошибки попадают в `log.txt`, подробный лог — в `ctrader.log`.

## Полезные файлы
- `ctrader.log` — журнал работы скрипта.
- `log.txt` — stdout/stderr из `run.sh`.
- `ctrader_uids.pkl` — список уже обработанных UID писем.
- `symbols.csv` — таблица с формулами и лимитами, изменения отслеживаются автоматически.
